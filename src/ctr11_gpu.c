#include <inttypes.h>

#define BRIGHTNESS 0x39
#define FB_TOP_LEFT 0x18300000
#define FB_TOP_RIGHT 0x18300000
#define FB_BOTTOM 0x18346500

static inline void regSet();

void __attribute__ ((naked)) a11Entry()
{
	__asm__ (
		"CPSID aif\n\t" //Disable interrupts
		"ldr r0,=_stack\n\t"
		"mov sp, r0"
	);

	regSet();
}

#define PDN_GPU_CNT (*(volatile uint32_t*)0x10141200)
#define LCD_REG(offset) (*((volatile uint32_t*)(0x10202000 + (offset))))
#define LCD_TOP_CONF_REG(offset) (*((volatile uint32_t*)(0x10202200 + (offset))))
#define LCD_BOT_CONF_REG(offset) (*((volatile uint32_t*)(0x10202A00 + (offset))))

#define LCD_TOP_CONF_BRIGHTNESS LCD_TOP_CONF_REG(0x40)
#define LCD_TOP_CONF_BRIGHTNESS LCD_BOT_CONF_REG(0x40)

#define PDC0_FRAMEBUFFER_SETUP_REG(offset) (*((volatile uint32_t*)(0x10400400 + (offset))))
#define PDC1_FRAMEBUFFER_SETUP_REG(offset) (*((volatile uint32_t*)(0x10400500 + (offset))))

#define PDC0_FRAMEBUFFER_SETUP_DIMS PDC0_FRAMEBUFFER_SETUP_REG(0x5C)
#define PDC0_FRAMEBUFFER_SETUP_FBA_ADDR_1 PDC0_FRAMEBUFFER_SETUP_REG(0x68)
#define PDC0_FRAMEBUFFER_SETUP_FBA_ADDR_2 PDC0_FRAMEBUFFER_SETUP_REG(0x6C)
#define PDC0_FRAMEBUFFER_SETUP_FB_FORMAT PDC0_FRAMEBUFFER_SETUP_REG(0x70)
#define PDC0_FRAMEBUFFER_SETUP_FB_SELECT PDC0_FRAMEBUFFER_SETUP_REG(0x78)
#define PDC0_FRAMEBUFFER_SETUP_DISCO PDC0_FRAMEBUFFER_SETUP_REG(0x84)
#define PDC0_FRAMEBUFFER_SETUP_FB_STRIDE PDC0_FRAMEBUFFER_SETUP_REG(0x90)
#define PDC0_FRAMEBUFFER_SETUP_FBB_ADDR_1 PDC0_FRAMEBUFFER_SETUP_REG(0x94)
#define PDC0_FRAMEBUFFER_SETUP_FBB_ADDR_2 PDC0_FRAMEBUFFER_SETUP_REG(0x98)

static inline void regSet()
{
	volatile uint32_t *entry = (uint32_t *)0x1FFFFFF8;

	PDN_GPU_CNT = 0x1007F; //bit0: Enable GPU regs 0x10400000+, bit16 turn on LCD backlight?
	LCD_REG(0x14) = 0x00000001; //UNKNOWN register, maybe LCD related? 0x10202000
	LCD_REG(0xC) &= 0xFFFEFFFE; //UNKNOWN register, maybe LCD related?

	LCD_TOP_CONF_BRIGHTNESS = BRIGHTNESS;
	LCD_BOT_CONF_BRIGHTNESS = BRIGHTNESS;
	LCD_TOP_CONF_REG(0x44) = 0x1023E; //unknown
	LCD_BOT_CONF_REG(0x44) = 0x1023E; //unknown

	// Top screen
	PDC0_FRAMEBUFFER_SETUP_REG(0x00) = 0x000001c2; //unknown
	PDC0_FRAMEBUFFER_SETUP_REG(0x04) = 0x000000d1; //unknown
	PDC0_FRAMEBUFFER_SETUP_REG(0x08) = 0x000001c1;
	PDC0_FRAMEBUFFER_SETUP_REG(0x0c) = 0x000001c1;
	PDC0_FRAMEBUFFER_SETUP_REG(0x10) = 0x00000000;
	PDC0_FRAMEBUFFER_SETUP_REG(0x14) = 0x000000cf;
	PDC0_FRAMEBUFFER_SETUP_REG(0x18) = 0x000000d1;
	PDC0_FRAMEBUFFER_SETUP_REG(0x1c) = 0x01c501c1;
	PDC0_FRAMEBUFFER_SETUP_REG(0x20) = 0x00010000;
	PDC0_FRAMEBUFFER_SETUP_REG(0x24) = 0x0000019d;
	PDC0_FRAMEBUFFER_SETUP_REG(0x28) = 0x00000002;
	PDC0_FRAMEBUFFER_SETUP_REG(0x2c) = 0x00000192;
	PDC0_FRAMEBUFFER_SETUP_REG(0x30) = 0x00000192;
	PDC0_FRAMEBUFFER_SETUP_REG(0x34) = 0x00000192;
	PDC0_FRAMEBUFFER_SETUP_REG(0x38) = 0x00000001;
	PDC0_FRAMEBUFFER_SETUP_REG(0x3c) = 0x00000002;
	PDC0_FRAMEBUFFER_SETUP_REG(0x40) = 0x01960192;
	PDC0_FRAMEBUFFER_SETUP_REG(0x44) = 0x00000000;
	PDC0_FRAMEBUFFER_SETUP_REG(0x48) = 0x00000000;
	PDC0_FRAMEBUFFER_SETUP_DIMS = (240 << 16) | (400u);
	PDC0_FRAMEBUFFER_SETUP_REG(0x60) = 0x01c100d1;
	PDC0_FRAMEBUFFER_SETUP_REG(0x64) = 0x01920002;
	PDC0_FRAMEBUFFER_SETUP_FBA_ADDR_1 = 0x18300000;
	PDC0_FRAMEBUFFER_SETUP_FB_FORMAT = 0x80341;
	PDC0_FRAMEBUFFER_SETUP_REG(0x74) = 0x00010501;
	PDC0_FRAMEBUFFER_SETUP_FB_SELECT = 0;
	PDC0_FRAMEBUFFER_SETUP_FB_STRIDE = 240u * 3;
	PDC0_FRAMEBUFFER_SETUP_REG(0x9C) = 0x00000000;

	// Disco register
	for(volatile uint32_t i = 0; i < 256; i++)
		PDC0_FRAMEBUFFER_SETUP_DISCO = 0x10101 * i;

	// Bottom screen
	PDC1_FRAMEBUFFER_SETUP_REG(0x00) = 0x000001c2;
	PDC1_FRAMEBUFFER_SETUP_REG(0x04) = 0x000000d1;
	PDC1_FRAMEBUFFER_SETUP_REG(0x08) = 0x000001c1;
	PDC1_FRAMEBUFFER_SETUP_REG(0x0c) = 0x000001c1;
	PDC1_FRAMEBUFFER_SETUP_REG(0x10) = 0x000000cd;
	PDC1_FRAMEBUFFER_SETUP_REG(0x14) = 0x000000cf;
	PDC1_FRAMEBUFFER_SETUP_REG(0x18) = 0x000000d1;
	PDC1_FRAMEBUFFER_SETUP_REG(0x1c) = 0x01c501c1;
	PDC1_FRAMEBUFFER_SETUP_REG(0x20) = 0x00010000;
	PDC1_FRAMEBUFFER_SETUP_REG(0x24) = 0x0000019d;
	PDC1_FRAMEBUFFER_SETUP_REG(0x28) = 0x00000052;
	PDC1_FRAMEBUFFER_SETUP_REG(0x2c) = 0x00000192;
	PDC1_FRAMEBUFFER_SETUP_REG(0x30) = 0x00000192;
	PDC1_FRAMEBUFFER_SETUP_REG(0x34) = 0x0000004f;
	PDC1_FRAMEBUFFER_SETUP_REG(0x38) = 0x00000050;
	PDC1_FRAMEBUFFER_SETUP_REG(0x3c) = 0x00000052;
	PDC1_FRAMEBUFFER_SETUP_REG(0x40) = 0x01980194;
	PDC1_FRAMEBUFFER_SETUP_REG(0x44) = 0x00000000;
	PDC1_FRAMEBUFFER_SETUP_REG(0x48) = 0x00000011;
	PDC1_FRAMEBUFFER_SETUP_FB_DIMS = (240u << 16) | 320u;
	PDC1_FRAMEBUFFER_SETUP_REG(0x60) = 0x01c100d1;
	PDC1_FRAMEBUFFER_SETUP_REG(0x64) = 0x01920052;
	PDC1_FRAMEBUFFER_SETUP_FBA_ADDR_1 = 0x18300000 + 0x46500;
	PDC1_FRAMEBUFFER_SETUP_FB_FORMAT = 0x80301;
	PDC1_FRAMEBUFFER_SETUP_REG(0x74) = 0x00010501;
	PDC1_FRAMEBUFFER_SETUP_FB_SELECT = 0;
	PDC1_FRAMEBUFFER_SETUP_FB_STRIDE = 240u * 3;
	PDC1_FRAMEBUFFER_SETUP_REG(0x9C) = 0x00000000;

	// Disco register
	for(volatile uint32_t i = 0; i < 256; i++)
		PDC1_FRAMEBUFFER_SETUP_DISCO = 0x10101 * i;

	PDC0_FRAMEBUFFER_SETUP_FBA_ADDR_1 = FB_TOP_LEFT;
	PDC0_FRAMEBUFFER_SETUP_FBA_ADDR_2 = FB_TOP_LEFT;
	PDC0_FRAMEBUFFER_SETUP_FBB_ADDR_1 = FB_TOP_RIGHT;
	PDC0_FRAMEBUFFER_SETUP_FBB_ADDR_2 = FB_TOP_RIGHT;
	PDC1_FRAMEBUFFER_SETUP_FBA_ADDR_1 = FB_BOTTOM;
	PDC1_FRAMEBUFFER_SETUP_FBA_ADDR_2 = FB_BOTTOM;

	// Reset the entry
	*entry = 0;

	// Wait for entry to be set
	while(!*entry);

	// Jump
	((void (*)())*entry)();
}

